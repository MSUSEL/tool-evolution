import json
import time
import subprocess
from FileRunner import FileRunner
from CommonVariables import pip_releases, binary_files, results, threads, clear_threads

###
# Display Program Title
###
print("CVE BIN TOOL Runner")
print("===================", end='\n\n')


###
# Calculate Scores
###
for release in pip_releases:

    print("\nDownloading Release "+release)
    # download that version of cve
    j = subprocess.run( "pip install cve-bin-tool==" + release, shell=True, capture_output=True )
    print(j.stdout.decode())

    # Add a thread for every file being run
    for file_name in binary_files:
        FileRunner(file_name, release)
    
    # wait for all threads to finish
    for x in threads:
        x.join()
    print("\nAll Threads Finished\n")

    # clear threads list
    clear_threads()

###
# OutputResults To File
###
with open('cve-bin-tool-runner/data_outputs/results_' + str(int(time.time())) + '.json', \
        'w', encoding='utf-8') as output_file:
    json.dump(results, output_file, ensure_ascii=False, indent=4)

###
# End Program
###
print("\nProgram End")