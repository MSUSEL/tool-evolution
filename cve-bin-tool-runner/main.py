import os
import subprocess
import json
import time
from dotenv import load_dotenv
import concurrent.futures

###
# Define Helper Functions
###

def run(file_name, release):
    # create command string
    command = "cve-bin-tool " + os.path.join(path_to_binary, file_name)
    # run command and save results into p
    p = subprocess.run(command, shell=True, capture_output=True)
    # count the vulnerabilities detected by cve-bin-tool
    try:
        vulnerability_count = count_vulnerabilities(p, release)
    except:
        vulnerability_count = CANNOT_READ_OUTPUT_ERROR_CODE

    return {
        'file_name': file_name,
        'release': release,
        'vulnerability_count': vulnerability_count
    }
        

def count_vulnerabilities(output, version):
    if (version < "0.3.0"):
        # Cannot get to work
        return 0
    if (version == "0.3.1"):
        return vuln_count_v0(output)
    elif (version < "3"):
        return vuln_count_v1(output)
    else:
        return vuln_count_v3(output)

def vuln_count_v0(output):
    splits_by_colon = output.stdout.decode().split(':')
    if (len(splits_by_colon) != 5):
        raise Exception("Unclear which number is the number of vulnerabilities discovered");
    last_section = splits_by_colon[-1]
    return len(last_section.split("\n"))

def vuln_count_v1(output):
    if (len(output.stdout.decode()) == 0):
        return 0
    splits_by_line_breaker = output.stdout.decode()\
        .split("=================================================================")
    last_section = splits_by_line_breaker[-1]
    return last_section.count("HIGH") + last_section.count("MEDIUM")\
        + last_section.count("LOW") + last_section.count("CRITICAL")\
        + last_section.count("unknown")

def vuln_count_v2(output):
    if (output.returncode == 0):
        return 0
    error_string = output.stderr.decode()
    numbers_in_string = [int(s) for s in error_string.split() if s.isdigit()]
    if (len(numbers_in_string) != 1):
        raise Exception("Unclear which number is the number of vulnerabilities discovered");
    return numbers_in_string[0]

def vuln_count_v3(output):
    sections = output.stdout.decode().split("NewFound");
    last_section = sections[-1]
    return last_section.count("HIGH") + last_section.count("MEDIUM")\
        + last_section.count("LOW") + last_section.count("CRITICAL")\
        + (last_section.count("unknown") / 2)

###
# Initialize Variables
###

# Hardcoded for now. Data is from https://pypi.org/project/cve-bin-tool/#history
#   Note: Ignoring Pre-releases: "2.0a0", "3.1rc2", "3.1rc3"
pip_releases = ['3.1.1', '3.1', '3.0', '2.2.1', '2.2',\
                            '2.1.post1', '2.1', '2.0', '1.1', '1.0', '0.3.1']
CANNOT_READ_OUTPUT_ERROR_CODE = -101

# Load File names from binary
load_dotenv()
path_to_binary = os.getenv('PATH_TO_BINARY')
binary_files = os.listdir(path_to_binary)

# Initialize results dictionary
results = {}
for file_name in binary_files:
    results[file_name] = {}

###
# Display Program Title
###
print("CVE BIN TOOL Runner")
print("===================", end='\n\n')

###
# Calculate Scores
###

# Run once before multithreading to let the tool update its database
print("Updating database...")
j = subprocess.run("cve-bin-tool " + os.path.join(path_to_binary, binary_files[0]),\
        shell=True, capture_output=True)
print(j.stdout.decode())

for release in pip_releases:

    print("\nDownloading Release "+release)
    # download that version of cve
    j = subprocess.run( "pip install cve-bin-tool==" + release, shell=True, capture_output=True )
    print(j.stdout.decode())


    executer = concurrent.futures.ThreadPoolExecutor(max_workers=None)

    runs = []
    print("Starting to make Threads\n")
    for file_name in binary_files:
        runs.append(executer.submit(run, file_name, release))
    
    for r in concurrent.futures.as_completed(runs):
        result = r.result()
        file_name = result['file_name']
        release = result['release']
        vulns = result['vulnerability_count']
        results[file_name][release] = vulns
        print("found %d vulnerabilities in %s using release %s" \
            % (vulns, file_name, release))
        

###
# OutputResults To File
###
with open('cve-bin-tool-runner/data_outputs/results_' + str(int(time.time())) + '.json', \
        'w', encoding='utf-8') as output_file:
    json.dump(results, output_file, ensure_ascii=False, indent=4)

###
# End Program
###
print("\nProgram End")